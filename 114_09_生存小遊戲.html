<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ«æ—¥å€–å­˜è€… v11.6 - å¼·åŠ›é–‹å±€ç‰ˆ</title>
    <style>
        :root { 
            --bg: #121212; --panel: #1e1e1e; --text: #eee;
            --hp: #e74c3c; --hg: #f39c12; --wt: #3498db; 
            --accent: #2ecc71; --gold: #ffd700; --boss: #8e44ad;
            --overlay: rgba(0,0,0,0.85);
        }
        body { 
            margin: 0; background: var(--bg); color: var(--text); 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            display: flex; justify-content: center; align-items: center; 
            min-height: 100vh; transition: background 1s; user-select: none; overflow: hidden;
        }
        
        .game-box { 
            width: 100%; max-width: 520px; 
            background: var(--panel); border-radius: 16px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.6); 
            border: 1px solid #333; position: relative; 
            overflow: hidden; transition: 0.5s;
        }

        /* --- ç‰¹æ•ˆå±¤ --- */
        .fx-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 50; overflow: hidden;
        }
        
        /* 1. æ–¬æ“Šç‰¹æ•ˆ (Slash) */
        .fx-slash {
            position: absolute; width: 120px; height: 120px;
            border-bottom: 5px solid #fff;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.9);
            opacity: 0; transform: rotate(-45deg) scale(0.5);
        }
        @keyframes anim-slash {
            0% { opacity: 0; transform: translate(-30px, -30px) rotate(-45deg) scale(0.5); }
            40% { opacity: 1; transform: translate(0, 0) rotate(-45deg) scale(1.2); }
            100% { opacity: 0; transform: translate(40px, 40px) rotate(-45deg) scale(1.5); }
        }
        .play-slash { animation: anim-slash 0.25s ease-out; }

        /* 2. é‡æ“Šç‰¹æ•ˆ (Smash) */
        .fx-smash {
            position: absolute; width: 80px; height: 80px;
            border: 4px solid #fff; border-radius: 50%;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            opacity: 0; transform: scale(0.1);
        }
        @keyframes anim-smash {
            0% { opacity: 1; transform: scale(0.2); border-width: 10px; }
            50% { opacity: 0.8; transform: scale(1.5); border-width: 4px; }
            100% { opacity: 0; transform: scale(2.5); border-width: 0px; }
        }
        .play-smash { animation: anim-smash 0.3s ease-out; }

        /* 3. å°„æ“Šç‰¹æ•ˆ (Shoot) */
        .fx-shoot {
            position: absolute; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(255,255,200,0.8) 0%, transparent 20%);
            opacity: 0; mix-blend-mode: screen;
        }
        @keyframes anim-shoot {
            0% { opacity: 1; transform: scale(0.5); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 0; transform: scale(1.5); }
        }
        .play-shoot { animation: anim-shoot 0.15s ease-out; }

        /* å—æ“Šç´…å± */
        .dmg-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: red; opacity: 0; pointer-events: none; z-index: 40;
        }
        @keyframes flash-red { 0% { opacity: 0.4; } 100% { opacity: 0; } }
        .play-dmg { animation: flash-red 0.3s ease-out; }

        /* æ•µäººå‹•ä½œ */
        @keyframes lunge { 
            0% { transform: scale(1) translateY(0); } 
            50% { transform: scale(1.4) translateY(30px); } 
            100% { transform: scale(1) translateY(0); } 
        }
        .enemy-atk-anim { animation: lunge 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .enemy-hit-anim { animation: hit-shake 0.4s; }
        @keyframes hit-shake { 
            0% { transform: translate(0, 0); filter: brightness(1); } 
            25% { transform: translate(-5px, 5px); filter: brightness(3) sepia(1) hue-rotate(-50deg); } 
            50% { transform: translate(5px, -5px); } 
            75% { transform: translate(-5px, -5px); } 
            100% { transform: translate(0, 0); filter: brightness(1); } 
        }


        /* --- UI æ¨£å¼ --- */
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--overlay); z-index: 100; display: none; flex-direction: column; padding: 20px; box-sizing: border-box; backdrop-filter: blur(5px); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .modal-title { font-size: 20px; font-weight: bold; color: var(--gold); }
        .close-btn { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; }
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 8px; background: #333; border: 1px solid #444; color: #aaa; cursor: pointer; border-radius: 5px; font-size: 13px; }
        .tab-btn.active { background: var(--accent); color: #000; font-weight: bold; border-color: var(--accent); }
        .gallery-content { flex: 1; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding-right: 5px; }
        .g-item { background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 8px; padding: 10px; display: flex; align-items: center; gap: 10px; }
        .g-icon { font-size: 28px; width: 40px; text-align: center; }
        .g-info { display: flex; flex-direction: column; }
        .g-name { font-size: 13px; font-weight: bold; color: #fff; }
        .g-desc { font-size: 10px; color: #aaa; margin-top: 2px; }
        .g-stat { color: var(--accent); }

        .scene-header { padding: 20px; text-align: center; position: relative; z-index: 2; background: linear-gradient(180deg, rgba(0,0,0,0.6), transparent); border-bottom: 1px solid rgba(255,255,255,0.1); transition: background 0.5s; }
        .scene-title { font-size: 22px; font-weight: 800; letter-spacing: 1px; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .scene-tag { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; opacity: 0.7; margin-top: 5px; }

        .equip-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px 20px 20px; background: rgba(0,0,0,0.2); border-bottom: 1px solid #333; }
        .equip-slot { background: #252525; border: 2px solid #333; border-radius: 10px; padding: 10px; display: flex; align-items: center; gap: 10px; position: relative; overflow: hidden; transition: 0.3s; }
        .equip-slot.updated { border-color: var(--gold); animation: flash 0.5s; }
        .e-icon { font-size: 32px; background: #111; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; border-radius: 8px; }
        .e-info { display: flex; flex-direction: column; }
        .e-name { font-weight: bold; font-size: 14px; color: #fff; }
        .e-stat { font-size: 11px; color: var(--accent); }
        .e-label { position: absolute; top: 2px; right: 5px; font-size: 9px; color: #666; text-transform: uppercase; }

        .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); background: rgba(0,0,0,0.2); border-bottom: 1px solid #333; }
        .dash-item { padding: 12px 5px; text-align: center; border-right: 1px solid rgba(255,255,255,0.05); }
        .dash-val { font-size: 16px; font-weight: bold; display: block; }
        .dash-lbl { font-size: 9px; color: #888; text-transform: uppercase; }

        .ap-bar { background: #111; padding: 10px; text-align: center; height: 10px; display: flex; justify-content: center; gap: 6px; }
        .ap-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 8px var(--accent); transition: 0.3s; }
        .ap-off { background: #333; box-shadow: none; transform: scale(0.7); }

        .bars-container { padding: 15px 20px; background: rgba(0,0,0,0.1); }
        .bar-wrap { display: flex; align-items: center; margin-bottom: 6px; font-size: 11px; }
        .bar-track { flex: 1; height: 5px; background: #000; border-radius: 3px; overflow: hidden; margin: 0 10px; }
        .bar-fill { height: 100%; border-radius: 3px; transition: width 0.4s; }

        .bag-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 15px 20px; }
        .bag-item { background: rgba(255,255,255,0.05); padding: 6px 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.05); font-size: 13px; }
        .bag-btn { background: rgba(255,255,255,0.1); border: none; color: #fff; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; }

        #combat-panel { margin: 0 20px 15px; padding: 15px; border-radius: 12px; background: linear-gradient(135deg, #3a1111, #1a0505); border: 1px solid var(--hp); display: none; position: relative; }
        .boss-mode { background: linear-gradient(135deg, #2d1a47, #0f0518) !important; border-color: var(--boss) !important; }
        .enemy-icon { font-size: 40px; display: inline-block; animation: float 3s infinite ease-in-out; text-align: center; width: 100%; transition: 0.2s; }
        
        .actions-grid { padding: 0 20px 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-act { padding: 15px; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; color: #fff; cursor: pointer; position: relative; overflow: hidden; transition: 0.2s; box-shadow: 0 4px 0 rgba(0,0,0,0.3); }
        .btn-act:active { transform: translateY(4px); box-shadow: none; }
        .btn-act:disabled { opacity: 0.3; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .c-exp { background: linear-gradient(135deg, #2980b9, #2c3e50); grid-column: span 2; }
        .c-atk { background: linear-gradient(135deg, #c0392b, #8e44ad); width: 100%; margin-top: 10px; }
        .c-rest { background: linear-gradient(135deg, #8e44ad, #2c3e50); grid-column: span 2; display: none; }
        .c-restart { background: var(--accent); grid-column: span 2; display: none; color:#000; }
        .c-book { background: #444; color: #aaa; font-size: 12px; padding: 10px; }

        .log-box { height: 90px; overflow-y: auto; margin: 0 20px 20px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; font-size: 12px; color: #aaa; border-left: 2px solid #444; }
        .float-txt { position: absolute; font-weight: 900; font-size: 22px; pointer-events: none; animation: floatUp 0.8s forwards; z-index: 100; text-shadow: 0 2px 4px #000; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(0.8); } 50% { transform: translateY(-20px) scale(1.2); } 100% { opacity: 0; transform: translateY(-50px) scale(1); } }
        @keyframes flash { 0% { background: var(--gold); } 100% { background: #252525; } }
        
        .vignette { position: absolute; top:0; left:0; right:0; bottom:0; pointer-events: none; z-index: 10; background: radial-gradient(circle, transparent 50%, rgba(0,0,0,0.5) 100%); }
        .low-hp-anim { animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 0%, 100% { box-shadow: inset 0 0 20px rgba(255,0,0,0); } 50% { box-shadow: inset 0 0 60px rgba(255,0,0,0.4); } }
        .shake { animation: shake 0.4s; }
        @keyframes shake { 0%,100% {transform:translateX(0)} 25% {transform:translateX(-5px)} 75% {transform:translateX(5px)} }
    </style>
</head>
<body>

<div class="game-box" id="gameUI">
    <div class="fx-layer">
        <div id="fxContainer"></div>
        <div id="dmgFX" class="dmg-overlay"></div>
    </div>
    
    <div class="vignette" id="vignette"></div>

    <div id="galleryModal" class="modal">
        <div class="modal-header">
            <span class="modal-title">ğŸ“– ç”Ÿå­˜åœ–é‘‘</span>
            <button class="close-btn" onclick="toggleGallery(false)">Ã—</button>
        </div>
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('items')">ç‰©è³‡</button>
            <button class="tab-btn" onclick="switchTab('wep')">æ­¦å™¨</button>
            <button class="tab-btn" onclick="switchTab('arm')">é˜²å…·</button>
        </div>
        <div id="galleryContent" class="gallery-content"></div>
    </div>

    <div class="scene-header" id="sceneHeader">
        <div class="scene-title" id="s-name">å®‰å…¨é¿é›£æ‰€</div>
        <div class="scene-tag" id="s-desc">SAFE ZONE</div>
    </div>

    <div class="equip-container">
        <div class="equip-slot" id="slot-wep">
            <span class="e-label">WEAPON</span>
            <div class="e-icon" id="wep-icon">âœŠ</div>
            <div class="e-info">
                <span class="e-name" id="wep-name">èµ¤æ‰‹ç©ºæ‹³</span>
                <span class="e-stat" id="wep-stat">ATK +0</span>
            </div>
        </div>
        <div class="equip-slot" id="slot-arm">
            <span class="e-label">ARMOR</span>
            <div class="e-icon" id="arm-icon">ğŸ‘•</div>
            <div class="e-info">
                <span class="e-name" id="arm-name">ç ´èˆŠè¥¯è¡«</span>
                <span class="e-stat" id="arm-stat">DEF +0</span>
            </div>
        </div>
    </div>

    <div class="dashboard">
        <div class="dash-item"><span class="dash-val" id="d-day">1</span><span class="dash-lbl">å¤©æ•¸</span></div>
        <div class="dash-item"><span class="dash-val" id="d-atk">10</span><span class="dash-lbl">æ”»æ“Š</span></div>
        <div class="dash-item"><span class="dash-val" id="d-def">2</span><span class="dash-lbl">é˜²ç¦¦</span></div>
        <div class="dash-item"><span class="dash-val" id="d-rec">0</span><span class="dash-lbl">ç´€éŒ„</span></div>
    </div>

    <div class="ap-bar" id="ap-bar"></div>

    <div class="bars-container">
        <div class="bar-wrap">
            <span class="bar-icon">â¤ï¸</span>
            <div class="bar-track"><div id="bar-hp" class="bar-fill" style="background:var(--hp); width:100%"></div></div>
            <span id="txt-hp">100</span>
        </div>
        <div class="bar-wrap">
            <span class="bar-icon">ğŸ–</span>
            <div class="bar-track"><div id="bar-hg" class="bar-fill" style="background:var(--hg); width:100%"></div></div>
        </div>
        <div class="bar-wrap">
            <span class="bar-icon">ğŸ’§</span>
            <div class="bar-track"><div id="bar-wt" class="bar-fill" style="background:var(--wt); width:100%"></div></div>
        </div>
    </div>

    <div class="bag-grid">
        <div class="bag-item"><span>ğŸ¥« ç½é ­ <b id="n-food">0</b></span> <button class="bag-btn" onclick="use('food')">ä½¿ç”¨</button></div>
        <div class="bag-item"><span>ğŸ¥¤ ç´”æ°´ <b id="n-water">0</b></span> <button class="bag-btn" onclick="use('water')">ä½¿ç”¨</button></div>
        <div class="bag-item"><span>ğŸ©¹ è—¥åŒ… <b id="n-med">0</b></span> <button class="bag-btn" onclick="use('med')">æ²»ç™‚</button></div>
        <div class="bag-item"><span>âš™ï¸ é›¶ä»¶ <b id="n-part">0</b></span> <button class="bag-btn" onclick="upgrade()">å¼·åŒ–</button></div>
    </div>

    <div id="combat-panel">
        <div class="enemy-icon" id="e-icon">ğŸ§Ÿ</div>
        <h3 style="margin:5px 0; color:#fff; text-align:center" id="e-name">å–ªå±</h3>
        <div class="bar-track" style="margin:8px auto; width:80%; height:8px; background:#000">
            <div id="e-bar" class="bar-fill" style="background:var(--hp); width:100%"></div>
        </div>
        <button id="atkBtn" class="btn-act c-atk" onclick="attack()">âš”ï¸ æˆ°é¬¥ (Combat)</button>
    </div>

    <div class="log-box" id="log"></div>

    <div class="actions-grid">
        <button id="btn-exp" class="btn-act c-exp" onclick="explore()">ğŸ—ºï¸ æ¢ç´¢å€åŸŸ (-1 AP)</button>
        <button id="btn-book" class="btn-act c-book" onclick="toggleGallery(true)">ğŸ“– ç”Ÿå­˜åœ–é‘‘</button>
        <button id="btn-rest" class="btn-act c-rest" onclick="rest()">ğŸ’¤ çµæŸé€™å¤© (Restore)</button>
        <button id="btn-re" class="btn-act c-restart" onclick="location.reload()">ğŸ”„ é‡æ–°é–‹å§‹ (Respawn)</button>
    </div>
</div>

<script>
    const Game = {
        hp: 100, maxHp: 100, hg: 100, wt: 100,
        food: 5, water: 5, med: 2, part: 0,
        baseAtk: 20, baseDef: 0, // åˆå§‹æ”»æ“Šæ”¹ç‚º 20
        day: 1, ap: 5, night: false, 
        record: localStorage.getItem('sv11_rec') || 0,
        equip: {
            wep: { n: "èµ¤æ‰‹ç©ºæ‹³", v: 0, i: "âœŠ", fx: "smash" },
            arm: { n: "ç ´èˆŠè¥¯è¡«", v: 0, i: "ğŸ‘•" }
        }
    };
    
    // å¹³è¡¡èª¿æ•´éçš„è£å‚™æ•¸å€¼èˆ‡ç‰¹æ•ˆ
    const GearDB = {
        wep: [
            { n: "ç”Ÿé½å°åˆ€", v: 5, i: "ğŸ”ª", fx: "slash", minDay: 0 },
            { n: "æ£’çƒæ£", v: 10, i: "ğŸ", fx: "smash", minDay: 2 },
            { n: "æ¶ˆé˜²æ–§", v: 18, i: "ğŸª“", fx: "slash", minDay: 5 },
            { n: "æ ¼æ´›å…‹æ‰‹æ§", v: 28, i: "ğŸ”«", fx: "shoot", minDay: 10 },
            { n: "éœ°å½ˆæ§", v: 40, i: "ğŸ¥–", fx: "shoot", minDay: 15 },
            { n: "éˆé‹¸", v: 60, i: "ğŸªš", fx: "slash", minDay: 20 },
            { n: "é›·å°„æ­¥æ§", v: 99, i: "ğŸ‘½", fx: "shoot", minDay: 30 }
        ],
        arm: [
            { n: "çš®å¤¾å…‹", v: 2, i: "ğŸ§¥", minDay: 0 },
            { n: "é‹å‹•è­·å…·", v: 5, i: "ğŸ¥‹", minDay: 3 },
            { n: "é˜²åˆºèƒŒå¿ƒ", v: 10, i: "ğŸ¦º", minDay: 8 },
            { n: "é®æš´ç›”ç”²", v: 18, i: "ğŸ›¡ï¸", minDay: 15 },
            { n: "å‹•åŠ›è£ç”²", v: 30, i: "ğŸ¤–", minDay: 25 }
        ],
        items: [
            { n: "éæœŸç½é ­", v: "æ¢å¾©é£½é£Ÿ", i: "ğŸ¥«", minDay: 0 },
            { n: "ç´”æ·¨æ°´", v: "æ¢å¾©æ°´åˆ†", i: "ğŸ¥¤", minDay: 0 },
            { n: "æ€¥æ•‘åŒ…", v: "æ¢å¾©å¤§é‡ç”Ÿå‘½", i: "ğŸ©¹", minDay: 0 },
            { n: "æ©Ÿæ¢°é›¶ä»¶", v: "å¼·åŒ–è£å‚™", i: "âš™ï¸", minDay: 0 }
        ]
    };

    let enemy = null;
    const UI = document.getElementById('gameUI');
    const Log = document.getElementById('log');

    const Scenes = [
        { n: "å»¢æ£„è¶…å¸‚", d: "SUPPLY RUN", color: "#e67e22" },
        { n: "å¸‚å€é†«é™¢", d: "MEDICAL ZONE", color: "#3498db" },
        { n: "è»äº‹å“¨ç«™", d: "DANGER ZONE", color: "#27ae60" },
        { n: "è’é‡å…¬è·¯", d: "WASTELAND", color: "#7f8c8d" }
    ];

    function init() { updateUI(); addLog("å€–å­˜è€…æ—¥èªŒå•Ÿå‹•...", "#aaa"); }
    function getTotalAtk() { return Game.baseAtk + Game.equip.wep.v; }
    function getTotalDef() { return Game.baseDef + Game.equip.arm.v; }

    function updateUI() {
        setText('d-day', Game.day);
        setText('d-atk', getTotalAtk());
        setText('d-def', getTotalDef());
        setText('d-rec', Game.record);
        setText('txt-hp', Math.floor(Game.hp));
        
        setText('wep-name', Game.equip.wep.n);
        setText('wep-stat', `ATK +${Game.equip.wep.v}`);
        setText('wep-icon', Game.equip.wep.i);
        setText('arm-name', Game.equip.arm.n);
        setText('arm-stat', `DEF +${Game.equip.arm.v}`);
        setText('arm-icon', Game.equip.arm.i);

        setText('n-food', Game.food); setText('n-water', Game.water);
        setText('n-med', Game.med); setText('n-part', Game.part);

        setBar('bar-hp', Game.hp, Game.maxHp);
        setBar('bar-hg', Game.hg, 100);
        setBar('bar-wt', Game.wt, 100);

        let apHtml = '';
        for(let i=0; i<5; i++) apHtml += `<div class="ap-dot ${i>=Game.ap?'ap-off':''}"></div>`;
        document.getElementById('ap-bar').innerHTML = apHtml;

        const vig = document.getElementById('vignette');
        if (Game.hp < 20) vig.classList.add('low-hp-anim');
        else vig.classList.remove('low-hp-anim');

        if (Game.night) {
            document.body.style.background = "#050510";
            document.getElementById('sceneHeader').style.opacity = "0.3";
            toggleDisplay('btn-exp', false);
            toggleDisplay('btn-rest', true);
        } else {
            document.body.style.background = "#121212";
            document.getElementById('sceneHeader').style.opacity = "1";
            toggleDisplay('btn-exp', true);
            toggleDisplay('btn-rest', false);
        }

        if (enemy) {
            document.getElementById('combat-panel').style.display = 'block';
            setText('e-name', enemy.name);
            setText('e-icon', enemy.icon);
            setBar('e-bar', enemy.hp, enemy.maxHp);
            if(enemy.isBoss) document.getElementById('combat-panel').classList.add('boss-mode');
            else document.getElementById('combat-panel').classList.remove('boss-mode');
            document.getElementById('btn-exp').style.display = 'none';
            document.getElementById('btn-book').style.display = 'none';
        } else {
            document.getElementById('combat-panel').style.display = 'none';
            if(!Game.night) document.getElementById('btn-exp').style.display = 'block';
            document.getElementById('btn-exp').disabled = (Game.ap <= 0);
            document.getElementById('btn-book').style.display = 'block';
        }
    }

    function toggleGallery(show) {
        document.getElementById('galleryModal').style.display = show ? 'flex' : 'none';
        if(show) switchTab('items');
    }

    function switchTab(type) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        const content = document.getElementById('galleryContent');
        content.innerHTML = '';
        let list = type === 'items' ? GearDB.items : (type === 'wep' ? GearDB.wep : GearDB.arm);
        list.forEach(item => {
            const div = document.createElement('div');
            div.className = 'g-item';
            let statHtml = type === 'wep' ? `<span class="g-stat">æ”»æ“Š +${item.v}</span>` : (type === 'arm' ? `<span class="g-stat">é˜²ç¦¦ +${item.v}</span>` : `<span class="g-stat">${item.v}</span>`);
            let dayHtml = item.minDay > 0 ? `<div style="color:${item.minDay>Game.day?'#555':'#e74c3c'}">Day ${item.minDay}+</div>` : '<div style="color:#aaa">åˆå§‹</div>';
            if(Game.day < item.minDay && type !== 'items') {
                div.innerHTML = `<div class="g-icon">?</div><div class="g-info"><span class="g-name">???</span><div class="g-desc">Day ${item.minDay} è§£é–</div></div>`;
            } else {
                div.innerHTML = `<div class="g-icon">${item.i}</div><div class="g-info"><span class="g-name">${item.n}</span><div class="g-desc">${statHtml}</div></div>${dayHtml}`;
            }
            content.appendChild(div);
        });
    }

    function explore() {
        if (!checkAP()) return;
        cost(8, 12);

        if (Game.day % 10 === 0 && !enemy) { spawnBoss(); return; }

        let s = Scenes[Math.floor(Math.random() * Scenes.length)];
        setText('s-name', s.n);
        setText('s-desc', s.d);
        document.getElementById('sceneHeader').style.background = `linear-gradient(180deg, ${s.color}aa, transparent)`;

        let roll = Math.random();
        if (roll < 0.5) {
            spawnEnemy();
        } 
        else if (roll < 0.85) {
            let loot = [];
            if(Math.random()<0.5) { Game.food++; loot.push("ç½é ­"); }
            if(Math.random()<0.5) { Game.water+=2; loot.push("ç´”æ°´x2"); }
            if(Math.random()<0.45) { Game.med++; loot.push("è—¥å“"); }
            if(Math.random()<0.3) { Game.part++; loot.push("é›¶ä»¶"); }
            if(loot.length>0) { floatTxt("+ç‰©è³‡", "#f1c40f"); addLog(`åœ¨${s.n}æ‰¾åˆ°: ${loot.join(', ')}`, "#2ecc71"); }
            else addLog("é€™è£¡ç©ºç©ºå¦‚ä¹Ÿ...", "#7f8c8d");
        } 
        else {
            findGear();
        }
        checkNight(); checkLife(); updateUI();
    }

    function findGear() {
        let isWep = Math.random() < 0.6;
        let list = isWep ? GearDB.wep : GearDB.arm;
        let valid = list.filter(i => Game.day >= i.minDay);
        let item = valid[Math.floor(Math.random() * valid.length)];
        let current = isWep ? Game.equip.wep : Game.equip.arm;
        
        if (item.v > current.v) {
            if(isWep) Game.equip.wep = item; else Game.equip.arm = item;
            floatTxt("è£å‚™å‡ç´š!", "#00d2d3");
            addLog(`âœ¨ ç™¼ç¾ <b>${item.i} ${item.n}</b>ï¼å·²è‡ªå‹•è£å‚™ã€‚`, "#00d2d3");
            let slotId = isWep ? 'slot-wep' : 'slot-arm';
            document.getElementById(slotId).classList.add('updated');
            setTimeout(()=>document.getElementById(slotId).classList.remove('updated'), 500);
        } else {
            Game.part += 1;
            addLog(`ç™¼ç¾ ${item.n}ï¼Œåˆ†è§£ç²å¾—é›¶ä»¶ã€‚`, "#7f8c8d");
        }
    }

    function spawnEnemy() {
        let scale = 1 + (Game.day * 0.15);
        enemy = {
            name: "éŠè•©å–ªå±", icon: "ğŸ§Ÿ",
            hp: Math.floor(40 * scale), maxHp: Math.floor(40 * scale),
            atk: Math.floor(8 * scale), isBoss: false
        };
        addLog("âš ï¸ å–ªå±æ“‹ä½äº†å»è·¯ï¼", "#e74c3c");
    }

    function spawnBoss() {
        let scale = 1 + (Game.day * 0.25);
        enemy = {
            name: `è®Šç•°é«” TYPE-${Game.day}`, icon: "ğŸ‘¹",
            hp: Math.floor(150 * scale), maxHp: Math.floor(150 * scale),
            atk: Math.floor(20 * scale), isBoss: true
        };
        addLog(`â˜ ï¸ è­¦å‘Šï¼ç¬¬ ${Game.day} å¤©çš„æµ©åŠ«é™è‡¨ï¼`, "#8e44ad");
        UI.classList.add('shake');
        setTimeout(()=>UI.classList.remove('shake'), 500);
    }

    function playFX(type) {
        const container = document.getElementById('fxContainer');
        const el = document.createElement('div');
        let rx = Math.random() * 20 - 10;
        let ry = Math.random() * 20 - 10;
        el.style.left = `calc(50% + ${rx}px)`;
        el.style.top = `calc(40% + ${ry}px)`;

        if(type === 'slash') el.className = 'fx-slash play-slash';
        else if(type === 'shoot') el.className = 'fx-shoot play-shoot';
        else el.className = 'fx-smash play-smash';

        container.appendChild(el);
        setTimeout(() => el.remove(), 400);
    }

    function attack() {
        let btn = document.getElementById('atkBtn');
        btn.disabled = true;

        let fxType = Game.equip.wep.fx || 'smash';
        playFX(fxType);

        let totalAtk = getTotalAtk();
        let crit = Math.random() < 0.2;
        let dmg = totalAtk + Math.floor(Math.random() * 10);
        if(crit) dmg *= 2;
        
        const eIcon = document.getElementById('e-icon');
        eIcon.classList.add('enemy-hit-anim');

        enemy.hp -= dmg;
        setTimeout(() => {
            floatTxt(`-${dmg}`, "#e74c3c", "70%", "40%");
            if(crit) floatTxt("CRIT!", "#f1c40f", "70%", "20%");
            eIcon.classList.remove('enemy-hit-anim');
            
            if (enemy.hp <= 0) {
                victory();
                btn.disabled = false;
            } else {
                setTimeout(enemyTurn, 400);
            }
            updateUI();
        }, 300);
    }

    function enemyTurn() {
        let btn = document.getElementById('atkBtn');
        const eIcon = document.getElementById('e-icon');
        eIcon.classList.add('enemy-atk-anim');
        
        let eDmg = enemy.isBoss ? enemy.atk * 1.5 : enemy.atk;
        if(Game.night) eDmg *= 1.5;
        let take = Math.max(1, Math.floor(eDmg - getTotalDef()));
        
        setTimeout(() => {
            Game.hp -= take;
            document.getElementById('dmgFX').classList.add('play-dmg');
            floatTxt(`-${take}`, "#fff", "20%", "40%");
            UI.classList.add('shake');
            
            setTimeout(() => {
                document.getElementById('dmgFX').classList.remove('play-dmg');
                UI.classList.remove('shake');
                eIcon.classList.remove('enemy-atk-anim');
                btn.disabled = false;
                checkLife();
                updateUI();
            }, 400);
        }, 200);
    }

    function victory() {
        if (enemy.isBoss) {
            floatTxt("BOSSæ“Šæ®º!", "#8e44ad");
            addLog("ğŸ† æ“Šæ•—è®Šç•°é«”ï¼ç²å¾—å¤§é‡ç‰©è³‡ï¼", "#8e44ad");
            Game.baseAtk += 5; Game.food += 3; Game.med += 2;
        } else {
            addLog("å¨è„…æ¸…é™¤ã€‚", "#2ecc71");
            if(Math.random() < 0.4) { Game.part++; floatTxt("+é›¶ä»¶", "#ccc"); }
        }
        enemy = null;
        checkNight(); updateUI();
    }

    function use(t) {
        if(Game[t] <= 0) return;
        Game[t]--;
        if(t==='food') { Game.hg = Math.min(100, Game.hg+40); Game.hp = Math.min(Game.maxHp, Game.hp+5); floatTxt("+é£½é£Ÿ", "#f39c12"); }
        if(t==='water') { Game.wt = Math.min(100, Game.wt+50); floatTxt("+æ°´åˆ†", "#3498db"); }
        if(t==='med') { Game.hp = Math.min(Game.maxHp, Game.hp+60); floatTxt("+ç”Ÿå‘½", "#e74c3c"); }
        updateUI();
    }

    function upgrade() {
        if(Game.part >= 3) {
            Game.part -= 3;
            Game.baseAtk += 2; Game.baseDef += 1;
            floatTxt("è¨“ç·´UP", "#2ecc71");
            addLog("æ¶ˆè€—é›¶ä»¶é€²è¡Œäº†ç”Ÿå­˜è¨“ç·´ã€‚", "#2ecc71");
        } else addLog("é›¶ä»¶ä¸è¶³ (éœ€3å€‹)", "#777");
        updateUI();
    }

    function rest() {
        Game.day++; Game.ap = 5; Game.night = false;
        cost(15, 20);
        addLog(`ğŸŒ… ç¬¬ ${Game.day} å¤©æ¸…æ™¨ã€‚`, "#fff");
        if(Game.hg > 0 && Game.wt > 0) Game.hp = Math.min(Game.maxHp, Game.hp + 10);
        checkLife(); updateUI();
    }

    function checkAP() { if (Game.ap > 0) { Game.ap--; return true; } return false; }
    function checkNight() { if (Game.ap <= 0 && !enemy) { Game.night = true; addLog("ğŸŒ‘ å¤œå¹•é™è‡¨...", "#9b59b6"); } }
    function cost(h, w) { Game.hg -= h; Game.wt -= w; }
    function checkLife() {
        if(Game.hg <= 0) Game.hp -= 10;
        if(Game.wt <= 0) Game.hp -= 15;
        if(Game.hp <= 0) {
            Game.hp = 0; updateUI();
            addLog("ğŸ’€ å€–å­˜è€…å·²æ­»äº¡ã€‚", "#c0392b");
            if(Game.day > Game.record) localStorage.setItem('sv11_rec', Game.day);
            document.querySelectorAll('.btn-act').forEach(b => b.style.display = 'none');
            document.getElementById('btn-re').style.display = 'grid';
        }
    }
    function setText(id, txt) { document.getElementById(id).textContent = txt; }
    function setBar(id, val, max) { document.getElementById(id).style.width = (val/max*100) + "%"; }
    function toggleDisplay(id, show) { document.getElementById(id).style.display = show ? 'block' : 'none'; }
    function addLog(msg, color) { const div = document.createElement('div'); div.innerHTML = `> <span style="color:${color}">${msg}</span>`; Log.insertBefore(div, Log.firstChild); }
    function floatTxt(txt, color, l, t) { const el = document.createElement('div'); el.className = 'float-txt'; el.textContent = txt; el.style.color = color; el.style.left = l || "50%"; el.style.top = t || "40%"; el.style.marginLeft = (Math.random()*40-20)+"px"; UI.appendChild(el); setTimeout(() => el.remove(), 800); }

    init();
</script>
</body>
</html>